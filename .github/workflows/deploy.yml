name: Deploy Synapse Bot

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allows manual triggering
    inputs:
      duration:
        description: 'How long to run the bot (in minutes, max 360)'
        required: false
        default: '360'
        type: string

env:
  NODE_VERSION: '20.x'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      run: npm test

  deploy:
    name: Run Discord Bot
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    environment: production
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Create data directories
      run: |
        mkdir -p ./data/backups
        echo "üìÅ Created data directories"
        
    - name: Start Discord Bot
      env:
        # Discord Bot Configuration
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        
        # Channel IDs
        SERVER_LOG_CHANNEL: ${{ secrets.SERVER_LOG_CHANNEL }}
        GIVEAWAY_CHANNEL_ID: ${{ secrets.GIVEAWAY_CHANNEL_ID }}
        
        # Server Configuration
        PORT: ${{ secrets.PORT }}
        
        # Database Paths (GitHub Actions filesystem)
        DATA_PATH: ./data
        BACKUP_PATH: ./data/backups
        
        # Economy Settings
        DAILY_AMOUNT: ${{ secrets.DAILY_AMOUNT }}
      run: |
        echo "ü§ñ Starting Synapse Discord Bot..."
        echo "‚è∞ Started at: $(date)"
        echo "üîß Bot will run for ${{ github.event.inputs.duration || '360' }} minutes"
        echo ""
        echo "üí° The bot is now running! This job will appear 'in progress' until:"
        echo "   - The time limit is reached, OR"
        echo "   - You manually cancel it, OR" 
        echo "   - An error occurs"
        echo ""
        echo "üéØ Your bot should now be online in Discord!"
        echo "---"
        
        # Calculate timeout in seconds (default 6 hours = 21600 seconds)
        DURATION_MINUTES="${{ github.event.inputs.duration || '360' }}"
        TIMEOUT_SECONDS=$((DURATION_MINUTES * 60))
        
        # Start the bot with timeout
        timeout $TIMEOUT_SECONDS npm start || {
          EXIT_CODE=$?
          echo ""
          echo "---"
          if [ $EXIT_CODE -eq 124 ]; then
            echo "‚è∞ Bot stopped after $DURATION_MINUTES minutes (time limit reached)"
          else
            echo "üõë Bot stopped with exit code: $EXIT_CODE"
          fi
          echo "‚è∞ Stopped at: $(date)"
          echo ""
          echo "üîÑ To restart the bot:"
          echo "   1. Go to the Actions tab"
          echo "   2. Click 'Deploy Synapse Bot'"
          echo "   3. Click 'Run workflow'"
        }

  # Optional: Scheduled runs (uncomment if you want automatic restarts)
  # scheduled-deploy:
  #   name: Scheduled Bot Run
  #   runs-on: ubuntu-latest
  #   # Run every 6 hours
  #   # Note: This will consume your GitHub Actions minutes quickly!
  #   if: github.event_name == 'schedule'
  #   environment: production
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #     
  #   - name: Setup Node.js
  #     uses: actions/setup-node@v4
  #     with:
  #       node-version: ${{ env.NODE_VERSION }}
  #       cache: 'npm'
  #       
  #   - name: Install dependencies
  #     run: npm ci
  #     
  #   - name: Create data directories
  #     run: mkdir -p ./data/backups
  #       
  #   - name: Start Discord Bot (Scheduled)
  #     env:
  #       DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
  #       SERVER_LOG_CHANNEL: ${{ secrets.SERVER_LOG_CHANNEL }}
  #       GIVEAWAY_CHANNEL_ID: ${{ secrets.GIVEAWAY_CHANNEL_ID }}
  #       PORT: ${{ secrets.PORT }}
  #       DATA_PATH: ./data
  #       BACKUP_PATH: ./data/backups
  #       DAILY_AMOUNT: ${{ secrets.DAILY_AMOUNT }}
  #     run: |
  #       echo "üîÑ Scheduled restart of Synapse Discord Bot..."
  #       echo "‚è∞ Started at: $(date)"
  #       timeout 21600 npm start || {
  #         echo "‚è∞ Scheduled run completed after 6 hours"
  #         echo "‚è∞ Stopped at: $(date)"
  #       }

# Uncomment to enable scheduled runs every 6 hours
# WARNING: This will consume GitHub Actions minutes very quickly!
# on:
#   schedule:
#     - cron: '0 */6 * * *'  # Every 6 hours
