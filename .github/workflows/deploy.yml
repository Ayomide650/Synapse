name: Deploy Synapse Bot

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allows manual triggering

env:
  NODE_VERSION: '20.x'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      run: npm test
      
    - name: Run linting (if available)
      run: npm run lint --if-present

  deploy:
    name: Deploy Bot on GitHub Actions
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Start Discord Bot
      env:
        # Discord Bot Configuration
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        
        # Channel IDs
        SERVER_LOG_CHANNEL: ${{ secrets.SERVER_LOG_CHANNEL }}
        GIVEAWAY_CHANNEL_ID: ${{ secrets.GIVEAWAY_CHANNEL_ID }}
        
        # Server Configuration
        PORT: ${{ secrets.PORT }}
        
        # Database Paths (GitHub Actions filesystem)
        DATA_PATH: ./data
        BACKUP_PATH: ./data/backups
        
        # Economy Settings
        DAILY_AMOUNT: ${{ secrets.DAILY_AMOUNT }}
      run: |
        echo "ü§ñ Starting Synapse Discord Bot..."
        echo "Bot will run for up to 6 hours on GitHub Actions"
        echo "Started at: $(date)"
        
        # Create data directories if they don't exist
        mkdir -p ./data/backups
        
        # Add timeout to prevent hanging
        timeout 21600 npm start || {
          echo "‚ö†Ô∏è  Bot stopped after 6 hours (GitHub Actions limit)"
          echo "Stopped at: $(date)"
        }

  # Optional: Create a job that runs on schedule to restart the bot
  scheduled-deploy:
    name: Scheduled Bot Restart
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    environment: production
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Start Discord Bot (Scheduled)
      env:
        # Discord Bot Configuration
        DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
        
        # Channel IDs
        SERVER_LOG_CHANNEL: ${{ secrets.SERVER_LOG_CHANNEL }}
        GIVEAWAY_CHANNEL_ID: ${{ secrets.GIVEAWAY_CHANNEL_ID }}
        
        # Server Configuration
        PORT: ${{ secrets.PORT }}
        
        # Database Paths (GitHub Actions filesystem)
        DATA_PATH: ./data
        BACKUP_PATH: ./data/backups
        
        # Economy Settings
        DAILY_AMOUNT: ${{ secrets.DAILY_AMOUNT }}
      run: |
        echo "üîÑ Scheduled restart of Synapse Discord Bot..."
        echo "Started at: $(date)"
        
        # Create data directories if they don't exist
        mkdir -p ./data/backups
        
        timeout 21600 npm start || {
          echo "‚ö†Ô∏è  Scheduled run completed after 6 hours"
          echo "Stopped at: $(date)"
        }

# Uncomment the schedule section if you want automatic restarts
# Note: This will consume GitHub Actions minutes quickly
# on:
#   schedule:
#     - cron: '0 */6 * * *'  # Runs every 6 hours
